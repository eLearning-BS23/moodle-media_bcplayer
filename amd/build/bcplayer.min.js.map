{"version":3,"sources":["../src/bcplayer.js"],"names":["define","$","Event","bcs","removeDataAttr","videos","forEach","video","innerHTML","setAttribute","getAttribute","removeAttribute","loadBrightcove","videoElements","document","querySelectorAll","bcAccounts","Array","prototype","slice","call","map","acc","player","filter","value","index","self","indexOf","length","getBcModule","obj","requirejs","undef","config","paths","Promise","resolve","require","bc","initVideosByAccount","on","account","res","controls","hasClass","removeClass","console","log","remainingTime","init","getLegacyEvents","done","events","one","FILTER_CONTENT_UPDATED"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * JW Player module.\n *\n * @module     media_bcplayer/bcplayer\n * @package    media_bcplayer\n * @copyright  2017 Ruslan Kabalin, Lancaster University\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\ndefine(['jquery', 'core/event'],($, Event) => {\n    const bcs = {}; // The object that will contain all our 'bc' RJS modules.\n\n    const removeDataAttr = (videos) => {\n        // Change all the data-player attribute to keep Brightcove from trying to\n        // initialize every player when the first script is retrieved.\n        videos.forEach((video) => {\n            video.innerHTML = '';\n            video.setAttribute('data-store-account', video.getAttribute('data-account'));\n            video.setAttribute('data-store-player', video.getAttribute('data-player'));\n            video.setAttribute('data-store-video-id', video.getAttribute('data-video-id'));\n            video.removeAttribute('data-account');\n            video.removeAttribute('data-player');\n            video.removeAttribute('data-video-id');\n        });\n    };\n\n    const loadBrightcove = async() => {\n        const videoElements = document.querySelectorAll('video-js');\n        const bcAccounts = Array.prototype.slice.call(videoElements)\n            .map((video) => ({acc : video.getAttribute('data-account'), player : video.getAttribute('data-player')}))\n            .filter((value, index, self) => self.indexOf(value) === index);\n        removeDataAttr(videoElements);\n        for (let index = 0; index < bcAccounts.length; index++) {\n            await getBcModule(bcAccounts[index]);\n        }\n    };\n\n    const getBcModule = function (obj) {\n\n        // Undefine 'bc' module so it can be reset using the next player's values.\n        // Because Brightcove's script forces itself to be named 'bc' when called as\n        // an AMD module, you have to undefine it before calling a second 'bc' module\n        // with a different url. Simply changing the path and requiring it won't work.\n        // It has to be undef'd before a second call can be made.\n        requirejs.undef('bc');\n\n        // Set the 'bc' module path using this video's account and player ids.\n        requirejs.config({\n            paths: {\n                'bc': `http://players.brightcove.net/${obj.acc}/${obj.player}_default/index.min`\n            }\n        });\n\n        return new Promise(((resolve) => {\n            // After 1 second signal that the job is finished with an error\n            require(['bc'], (bc) => {\n                // Store the current bc in bcs, because we're going to undefine it.\n                bcs[`bc${obj.acc}${obj.player}`] = bc;\n                // Initialize all the videos for this account.\n                const player = initVideosByAccount(obj);\n                player.on('loadedmetadata', () => {\n                    resolve(player);\n                });\n            });\n        }));\n    };\n\n    const initVideosByAccount = function (account) {\n        // eslint-disable-next-line max-len\n            const videos = document.querySelectorAll(`video-js[data-store-account='${account.acc}'][data-store-player='${account.player}']`);\n            let res;\n            videos.forEach((video) => {\n                video.setAttribute('data-account', video.getAttribute('data-store-account'));\n                video.setAttribute('data-player', video.getAttribute('data-store-player'));\n                video.setAttribute('data-video-id', video.getAttribute('data-store-video-id'));\n                res = bcs[`bc${account.acc}${account.player}`](video);\n                res.controls(true);\n                if (res.hasClass('vjs-play-button-shape-square')){\n                    res.removeClass('vjs-play-button-shape-square');\n                }\n                // res.on('loadedmetadata',() => {\n                //     console.log('Video duration: ' + res.duration() + 'secounds');\n                //     console.log('Video Playback speed: ' + res.playbackRate() );\n                //     console.log('User Active: ' + res.userActive() );\n                //\n                // });\n                    // Fired when the current playback position has changed * During playback this is fired every\n                    // 15-250 milliseconds, depending on the playback technology in use.\n                res.on('timeupdate', () => {\n                    // console.log('Video duration: ' + res.duration() + 'secounds');\n                    // console.log('Video Playback speed: ' + res.playbackRate() );\n                    // console.log('User Active: ' + res.userActive() );\n                    console.log('Video remaining time: ' + res.remainingTime() );\n                });\n            });\n            return res;\n    };\n\n    // Load all accounts and related players\n    return {\n        init() {\n\n            $(document).on('brightcoveinsertedtodom',() => {\n                loadBrightcove();\n            });\n\n\n            Event.getLegacyEvents().done((events) => {\n                let count = 0;\n                $(document).one(events.FILTER_CONTENT_UPDATED, () => {\n                    loadBrightcove();\n                    // $(\".editor_atto_wrap\").find('video-js').addBack('video-js').each(function() {\n                    //     const __self = $(this);\n                    //     __self.innerHTML = '';\n                    //     getBcModule({acc: __self.data('account'), player: __self.data('player')});\n                    // });\n                });\n            });\n        }\n\n    };\n\n});\n"],"file":"bcplayer.min.js"}